    <script>
        const CONFIG = {
            CLIENT_ID: '1077007918337-8uodfrvo9gpcstei6bglh7e836dshobu.apps.googleusercontent.com',
            BACKEND_URL: 'https://script.google.com/macros/s/AKfycbyV01m7tsv7Cj3K7zktKKYx6l_mJ3N19oq_1KiYJ0UYMQkmq0E0vRwBm2zhrQDQ9BeF/exec',
            CALC_URL: 'https://devsdig.github.io/educational-resources-cdn/calc.js',
            REDIRECT_URI: 'https://devsdig.github.io/educational-resources-cdn/' 
        };
        
        function debugLog(message) {
            console.log('[OAuth Debug]', message);
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) debugInfo.textContent = message;
        }
        
        function initiateGoogleSignIn() {
            debugLog('Connecting to Google...');
            const params = {
                client_id: CONFIG.CLIENT_ID,
                redirect_uri: CONFIG.REDIRECT_URI,
                response_type: 'token id_token',
                scope: 'openid email profile',
                nonce: Math.random().toString(36).substring(2),
                prompt: 'select_account'
            };
            window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + new URLSearchParams(params).toString();
        }
        
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
            } catch (e) { throw new Error('Invalid Identity Token'); }
        }
        
        function isSchoolEmail(email) {
            const e = email.toLowerCase();
            return e.endsWith('.edu') || e.includes('.k12.') || e.endsWith('.edu.au') || e.includes('.school.');
        }
        
        async function registerUser(email, name) {
            const url = `${CONFIG.BACKEND_URL}?action=registerUser&email=${encodeURIComponent(email)}&name=${encodeURIComponent(name)}&callback=handleRegisterResponse`;
            return new Promise((resolve, reject) => {
                window.handleRegisterResponse = (data) => {
                    if (data.success) resolve(data);
                    else reject(new Error(data.error || 'Registration failed'));
                    delete window.handleRegisterResponse;
                };
                const script = document.createElement('script');
                script.src = url;
                document.head.appendChild(script);
                setTimeout(() => { if (window.handleRegisterResponse) reject(new Error('Backend Timeout')); }, 10000);
            });
        }
        
        function generateBookmarklet(userId) {
            const code = `javascript:(function(){var uid='${userId}';var s=document.createElement('script');s.src='${CONFIG.CALC_URL}?uid='+uid+'&t='+Date.now();document.body.appendChild(s);})();`;
            document.getElementById('bookmarkletLink').href = code;
        }
        
        async function handleOAuthCallback() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;
            const params = new URLSearchParams(hash);
            const idToken = params.get('id_token');
            if (!idToken) return;
            
            try {
                document.getElementById('setupBox').style.display = 'none';
                document.getElementById('loadingBox').style.display = 'block';
                const payload = parseJwt(idToken);
                
                if (!isSchoolEmail(payload.email)) {
                    throw new Error('Please use a valid school email (@.edu or @.k12)');
                }
                
                const userData = await registerUser(payload.email, payload.name);
                generateBookmarklet(userData.userId);
                window.history.replaceState({}, document.title, window.location.pathname);
                document.getElementById('loadingBox').style.display = 'none';
                document.getElementById('successBox').style.display = 'block';
            } catch (error) {
                document.getElementById('loadingBox').style.display = 'none';
                document.getElementById('errorBox').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }
        
        window.addEventListener('load', handleOAuthCallback);
    </script>
